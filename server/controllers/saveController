const db = require("../models/database.js");

const saveController = {};

saveController.getSaved = async (req, res, next) => {
  try {
    const userQuery = "SELECT user_id FROM users WHERE username = $1";
    const userValues = [req.params.id];
    // console.log("reqparamschck uservalues", typeof userValues);
    console.log("reqparamschck paramid", typeof req.params.id);

    const userResponse = await db.query(userQuery, userValues);
    console.log(userResponse.rows[0]);
    console.log("sanitycheck", userResponse.rows[0].user_id);

    const allSaves = `SELECT * FROM savetable JOIN businesses ON savetable.business_id = businesses.business_id WHERE user_id = $1`;
    const values = [userResponse.rows[0].user_id];
    const response = await db.query(allSaves, values);
    console.log(response.rows);
    res.locals.saved = response.rows;
    //send the necessary response back
    return next();
  } catch (error) {
    console.log("error in getSaves controller");
    return next(error);
  }
};

saveController.addSaved = async (req, res, next) => {
  const { business_id } = res.locals.business;
  try {
    // console.log("this is res.locals", res.locals);
    // console.log("trying to select");
    const userQuery = "SELECT user_id FROM users WHERE username = $1";
    // console.log(res.locals);
    const userValues = [res.locals.username];
    // console.log("this is userValues", userValues);
    const userResponse = await db.query(userQuery, userValues);
    // console.log(userResponse);
    // console.log(business_id);

    const postSaved = `INSERT INTO savetable (user_id, business_id)
    VALUES ($1, $2)`;
    const postValues = [userResponse.rows[0].user_id, business_id];
    db.query(postSaved, postValues);
    next();
  } catch (error) {
    console.log("error in addSaves controller");
  }
};

module.exports = saveController;
